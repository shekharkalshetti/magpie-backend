# Magpie AI - Backend

FastAPI backend for LLM monitoring and content moderation platform.

## Quick Start (Local Development)

```bash
# Run complete setup (Docker required)
./setup.sh
```

This will:

- Start PostgreSQL, Redis, API, Celery Worker, and Nginx
- Create admin user with credentials
- Set up database and default project

**Access Points:**

- API Docs: http://localhost:8000/docs
- Health: http://localhost:8000/health
- Frontend: http://localhost:3000

## Services

- **API** - FastAPI application (port 8000)
- **Worker** - Celery async tasks
- **PostgreSQL** - Database (port 5432)
- **Redis** - Cache and message broker (port 6379)
- **Nginx** - Reverse proxy (port 80)

## Environment Variables

Required variables (auto-generated by setup.sh):

- `POSTGRES_PASSWORD` - Database password
- `SECRET_KEY` - JWT signing key
- `JWT_SECRET_KEY` - Auth token key
- `ADMIN_EMAIL` - Admin user email
- `ADMIN_PASSWORD` - Admin user password
- `ALLOWED_ORIGINS` - CORS origins (JSON array)

See `.env.example` for full list.

## Useful Commands

```bash
# View logs
docker compose logs -f              # All services
docker compose logs -f api          # API only

# Restart service
docker compose restart api

# Shell access
docker compose exec api bash

# Database access
docker compose exec postgres psql -U magpie -d magpie

# Stop services
docker compose stop

# Clean restart
docker compose down -v
./setup.sh
```

## Project Structure

```
backend/
├── src/                    # Application code
│   ├── main.py            # FastAPI app
│   ├── models.py          # Database models
│   ├── auth/              # Authentication
│   ├── users/             # User management
│   ├── projects/          # Project management
│   ├── policies/          # Content policies
│   ├── review_queue/      # Review system
│   └── tasks/             # Celery tasks
├── scripts/               # Utility scripts
│   ├── setup_admin.py    # Admin user creation
│   ├── create_project.py # Project creation
│   └── generate_api_key.py
├── requirements/          # Python dependencies
│   ├── base.txt          # Core dependencies
│   ├── dev.txt           # Development tools
│   └── prod.txt          # Production only
├── docker-compose.yml    # Service orchestration
├── Dockerfile            # API/Worker container
├── Dockerfile.llm        # vLLM GPU container
└── setup.sh              # Automated setup script
```

## Development

```bash
# Install dependencies
pip install -r requirements/dev.txt

# Run tests
pytest

# Lint
ruff check src/
```

## Production Deployment

See `/infra/` directory for AWS EC2 deployment automation.
